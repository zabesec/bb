services:
  subenum-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: subenum
      POSTGRES_PASSWORD: subenum
      POSTGRES_DB: subenum
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U subenum"]
      interval: 5s
      retries: 10

  subenum:
    build: .
    image: subenum:latest
    cap_add:
      - NET_RAW
      - NET_ADMIN
    volumes:
      - .:/app
      - ./config:/root/.config
      - ./wordlists:/wordlists
    environment:
      - CHAOS_API_KEY=${CHAOS_API_KEY}

  subenum-scheduler:
    build: .
    image: subenum-scheduler:latest
    depends_on:
      - subenum-db
    volumes:
      - .:/app
      - ./config:/root/.config
      - ./wordlists:/wordlists
    working_dir: /app
    environment:
      - CHAOS_API_KEY=${CHAOS_API_KEY}
      - PYTHONUNBUFFERED=1
    command: src/scheduler.py
    restart: unless-stopped

volumes:
  postgres_data:
